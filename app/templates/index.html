<html>
  <head>
    <title>{% block title %}Wikipedia Live Edits!{% end %}</title>

    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

  </head>
  <body>
      <div id="edit counts"><h1><span id="counter">{{edit_count}}</span> Edits Made!</h1></div>
    <div id="title"><h1>Top 10 Editors</h1></div>
    <div id="top_editors"></div>

    <script type="text/javascript">
        "use strict";

        var path = "ws://" + location.host + "{{reverse_url('api/stream', 'counter')}}";
        var connection = new WebSocket(path);

        connection.onmessage = function(event) {
                var data = JSON.parse(event.data);
                // Counter is a single row table, so every update should contain one insert and
                // maybe one delete (which we don't care about
                document.getElementById("counter").innerHTML = data.inserted[0][0]
        }

    </script>

    <script type="text/javascript">
        "use strict";

        var editors_histogram = {
            $schema: 'https://vega.github.io/schema/vega-lite/v4.json',
            mark: 'bar',
            height: 800,
            width: 800,
            data: {name: 'top10'},
            encoding: {
                x: {field: 'editor', type: 'nominal', sort: 'y'},
                y: {field: 'count', type: 'quantitative'},
            }
        };

        vegaEmbed('#top_editors', editors_histogram).then(function(chart) {

            var path = "ws://" + location.host + "{{reverse_url('api/stream', 'top10')}}";
            var connection = new WebSocket(path);

            function convert_to_editor(row) {
                return {editor: row[0], count: parseInt(row[1])};
            }

            function editor_in_array(e, arr) {
                return arr.find(i => i.editor === e.editor && i.count === e.count);
            }

            connection.onmessage = function(event) {
                    var data = JSON.parse(event.data);
                    var delete_values = data.deleted.map(convert_to_editor);
                    var changeSet = vega.changeset()
                            .insert(data.inserted.map(convert_to_editor))
                            .remove(d => editor_in_array(d, delete_values));

                    chart.view.change('top10', changeSet).resize().run();
            }
        });

    </script>
  </body>
</html>
